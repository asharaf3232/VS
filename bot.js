// =================================================================
// ุตูุงุฏ ุงูุฏุฑุฑ: v3.0 (ููุงุต ุฎุงุทู - ููุชุฑ ุฎููู + ูุฑูุจ ุณุฑูุน)
// =================================================================
import { ethers } from 'ethers';
import dotenv from 'dotenv';
import TelegramBot from 'node-telegram-bot-api';
import winston from 'winston';
import fs from 'fs';
import axios from 'axios';

// --- ูุธุงู ุงูุชุณุฌูู ---
const logger = winston.createLogger({
    level: 'info',
    format: winston.format.combine(
        winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
        winston.format.printf(info => `${info.timestamp} - ${info.level.toUpperCase()}: ${info.message}`)
    ),
    transports: [
        new winston.transports.File({ filename: 'sniper_bot_pro.log' }),
        new winston.transports.Console()
    ]
});

// --- ุชุญููู ุงูุฅุนุฏุงุฏุงุช ---
// (ููุณ ุฅุนุฏุงุฏุงุช v2.8ุ ูุฃููุง ูุง ุฒููุง ุจุญุงุฌุฉ ูุฌูู ุงูุฃุฑุจุงุญ ูุงูุบุงุฒ ุงูุฏููุงูููู)
dotenv.config();
const config = {
    PROTECTED_RPC_URL: process.env.PROTECTED_RPC_URL,
    NODE_URL: process.env.NODE_URL,
    GOPLUS_API_KEY: process.env.GOPLUS_API_KEY,
    WALLET_ADDRESS: process.env.WALLET_ADDRESS,
    PRIVATE_KEY: process.env.PRIVATE_KEY,
    TELEGRAM_BOT_TOKEN: process.env.TELEGRAM_BOT_TOKEN,
    TELEGRAM_ADMIN_CHAT_ID: process.env.TELEGRAM_ADMIN_CHAT_ID,
    ROUTER_ADDRESS: '0x10ED43C718714eb63d5aA57B78B54704E256024E',
    FACTORY_ADDRESS: '0xcA143Ce32Fe78f1f7019d7d551a6402fC5350c73',
    WBNB_ADDRESS: "0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c",
    BUY_AMOUNT_BNB: parseFloat(process.env.BUY_AMOUNT_BNB || '0.01'),
    GAS_PRIORITY_MULTIPLIER: parseInt(process.env.GAS_PRIORITY_MULTIPLIER || '2', 10),
    SLIPPAGE_LIMIT: parseInt(process.env.SLIPPAGE_LIMIT || '49', 10),
    GAS_LIMIT: BigInt(process.env.GAS_LIMIT || '800000'),
    MINIMUM_LIQUIDITY_BNB: parseFloat(process.env.MINIMUM_LIQUIDITY_BNB || '5.0'),
    TRAILING_STOP_LOSS_PERCENT: parseInt(process.env.TRAILING_STOP_LOSS_PERCENT || '20', 10),
    PARTIAL_TP_PERCENT: parseInt(process.env.PARTIAL_TP_PERCENT || '100', 10), 
    PARTIAL_TP_SELL_PERCENT: parseInt(process.env.PARTIAL_TP_SELL_PERCENT || '50', 10), 
    DEBUG_MODE: process.env.DEBUG_MODE === 'true',
    IS_PAUSED: false,
};

// --- ูุงุฌูุงุช ุงูุนููุฏ ุงูุฐููุฉ (ABIs) ---
const FACTORY_ABI = ['event PairCreated(address indexed token0, address indexed token1, address pair, uint)'];
const PAIR_ABI = ['function getReserves() external view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast)', 'function token0() external view returns (address)'];
const ROUTER_ABI = ['function getAmountsOut(uint amountIn, address[] memory path) public view returns (uint[] memory amounts)', 'function swapExactETHForTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) external payable returns (uint[] memory amounts)', 'function swapExactTokensForETHSupportingFeeOnTransferTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external'];
const ERC20_ABI = ['function decimals() view returns (uint8)', 'function approve(address spender, uint256 amount) external returns (bool)', 'function balanceOf(address account) external view returns (uint256)'];

// --- ุชููุฆุฉ ุงููุชุบูุฑุงุช ุงูุฑุฆูุณูุฉ ---
let provider, wallet, factoryContract, routerContract, wssProvider;
const activeTrades = [];
const telegram = new TelegramBot(config.TELEGRAM_BOT_TOKEN, { polling: true });
const userState = {};
const TRADES_FILE = 'active_trades.json';
const sellingLocks = new Set();
// (ูุญุชูุธ ุจููุณ ูุงุฆูุฉ ุงูุฅุนุฏุงุฏุงุช ูุฃููุง ูุง ุฒููุง ูุชุญูู ุจูุง)
const SETTING_PROMPTS = {
    "BUY_AMOUNT_BNB": "ูุฑุฌู ุฅุฑุณุงู ูุจูุบ ุงูุดุฑุงุก ุงูุฌุฏูุฏ ุจุงูู BNB (ูุซุงู: 0.01):",
    "GAS_PRIORITY_MULTIPLIER": "ูุฑุฌู ุฅุฑุณุงู ูุถุงุนู ุบุงุฒ ุงูุฃููููุฉ ุงูุฌุฏูุฏ (ูุซุงู: 2 ูุนูู ุถุนู ุงูููุชุฑุญ):",
    "SLIPPAGE_LIMIT": "ูุฑุฌู ุฅุฑุณุงู ูุณุจุฉ ุงูุงูุฒูุงู ุงูุณุนุฑู ุงูุฌุฏูุฏุฉ (ูุซุงู: 49):",
    "MINIMUM_LIQUIDITY_BNB": "ูุฑุฌู ุฅุฑุณุงู ุงูุญุฏ ุงูุฃุฏูู ููุณูููุฉ ุจุงูู BNB (ูุซุงู: 5.0):",
    "TRAILING_STOP_LOSS_PERCENT": "ูุฑุฌู ุฅุฑุณุงู ูุณุจุฉ ููู ุงูุฎุณุงุฑุฉ ุงููุชุญุฑู ุงูุฌุฏูุฏุฉ (ูุซุงู: 20):",
    "PARTIAL_TP_PERCENT": "ูุฑุฌู ุฅุฑุณุงู ูุณุจุฉ ุงูุฑุจุญ ูุฌูู ุงูุฃุฑุจุงุญ ุงูุฌุฒุฆู (ูุซุงู: 100):",
    "PARTIAL_TP_SELL_PERCENT": "ูุฑุฌู ุฅุฑุณุงู ุงููุณุจุฉ ุงููุฆููุฉ ููุจูุน ุนูุฏ ุฌูู ุงูุฃุฑุจุงุญ ุงูุฌุฒุฆู (ูุซุงู: 50):",
};

// =================================================================
// 1. ุงููุฏูู (Verifier)
// =================================================================
async function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// =================================================================
// ุฏุงูุฉ checkTokenSecurity - ูุณุฎุฉ v3.0 "ุงูููุงุต ุงูุฎุงุทู" (ููุชุฑ ุฎููู)
// =================================================================
async function checkTokenSecurity(tokenAddress, retry = true) {
    if (!config.GOPLUS_API_KEY) {
        logger.warn("[ูุญุต ุฃููู] ููุชุงุญ Go+ API ุบูุฑ ููุฌูุฏุ ุชู ุชุฎุทู ุงููุญุต.");
        return { is_safe: true, reason: "ูุญุต ุฃููู ูุนุทู" };
    }
    try {
        const url = `https://api.gopluslabs.io/api/v1/token_security/56?contract_addresses=${tokenAddress}`;
        const response = await axios.get(url, { headers: { 'X-API-KEY': config.GOPLUS_API_KEY } });
        const result = response.data.result[tokenAddress.toLowerCase()];

        if (!result) {
            if (retry) {
                // [ุชุทููุฑ v3.0] ุชูููู ูุชุฑุฉ ุงูุงูุชุธุงุฑ ุฅูู ุซุงููุฉ ูุงุญุฏุฉ ููุท
                logger.warn(`[ูุญุต ุฃููู] ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนููุฉ ูู Go+ุ ุณุฃูุชุธุฑ 1 ุซุงููุฉ ูุฃุญุงูู ูุฑุฉ ุฃุฎุฑู.`);
                await sleep(1000); 
                return checkTokenSecurity(tokenAddress, false);
            }
            return { is_safe: false, reason: "ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนููุฉ ูู Go+" };
        }

        // --- [ุชุทููุฑ v3.0] ุงูููุชุฑ ุงูุฎููู (ููุท ุงูููุงุฑุซ ุงูููุฑูุฉ) ---

        // 1. ูู ูู ูุฎ ุนุณู ูุงุถุญุ (ุณุฑูุน)
        if (result.is_honeypot === '1') {
             return { is_safe: false, reason: "ูุฎ ุนุณู ุญุณุจ Go+" };
        }
        
        // 2. ูู ุถุฑูุจุฉ ุงูุจูุน ูุงุฑุซูุฉุ (ุณุฑูุน)
        // [ุชุทููุฑ v3.0] ุชุบููุฑ ุงูุงูุชุฑุงุถู ุฅูู 0 ูุฑูุน ุงูุญุฏ ุฅูู 25%
        const sellTax = parseFloat(result.sell_tax || '0'); 
        if (sellTax > 0.25) { // ุชู ุฑูุน ุงูุญุฏ ุฅูู 25%
             return { is_safe: false, reason: `ุถุฑูุจุฉ ุจูุน ูุฑุชูุนุฉ ุฌุฏุงู (${(sellTax * 100).toFixed(0)}%)` };
        }

        // 3. ูู ูู ุนูุฏ ูููู (Proxy)ุ (ุณุฑูุน)
        // (ูุฐุง ุงูููุชุฑ ุถุฑูุฑู ุจูุงุกู ุนูู ุงูุชุดุงูู)
        if (result.is_proxy === '1') {
            return { is_safe: false, reason: "ุนูุฏ ูููู (Proxy) - ุฎุทุฑ ุงูุชุฑููุฉ" };
        }

        // --- [ุชุทููุฑ v3.0] ุชู ุญุฐู ููุงุชุฑ (ุงูุญูุชุงูุ ุงูุฃููุงูุ ุงููุงูู) ---
        // ูุฃููุง ุจุทูุฆุฉ ูุชููุนูุง ูู ุงูุดุฑุงุก ุงูุณุฑูุน (ุชุณุจุจ ุฎุทุฃ 100% ุญูุชุงู).
        // ุณูุนุชูุฏ ุนูู TSL ู TP ูููุฑูุจ.
        
        logger.info(`[ูุญุต ุฃููู] โ ุงูุนููุฉ ุงุฌุชุงุฒุช ุงูููุชุฑ ุงูุฎููู (v3.0).`);
        return { is_safe: true };

    } catch (error) {
        logger.error(`[ูุญุต ุฃููู] ๐จ ุฎุทุฃ ูู ุงูุชูุงุตู ูุน Go+ API: ${error.message}`);
        return { is_safe: false, reason: "ุฎุทุฃ ูู API ุงููุญุต ุงูุฃููู" };
    }
}
// <<< ููุงูุฉ ุชุทููุฑ v3.0


async function fullCheck(pairAddress, tokenAddress) {
    try {
        logger.info(`[ูุญุต] ุจุฏุก ุงููุญุต ุงูุดุงูู ูู ${tokenAddress}`);
        const pairContract = new ethers.Contract(pairAddress, PAIR_ABI, provider); 
        const reserves = await pairContract.getReserves();
        const token0 = await pairContract.token0();
        const wbnbReserve = token0.toLowerCase() === config.WBNB_ADDRESS.toLowerCase() ? reserves[0] : reserves[1];
        const wbnbLiquidity = parseFloat(ethers.formatEther(wbnbReserve));
        logger.info(`[ูุญุต] ุงูุณูููุฉ ุงูููุชุดูุฉ: ${wbnbLiquidity.toFixed(2)} BNB`);
        
        // (ูุญุชูุธ ุจูุญุต ุงูุณูููุฉ ุงูุฃุฏูู)
        if (wbnbLiquidity < config.MINIMUM_LIQUIDITY_BNB) {
            return { passed: false, reason: `ุณูููุฉ ุบูุฑ ูุงููุฉ (${wbnbLiquidity.toFixed(2)} BNB)` };
        }
        
        // (ุงุณุชุฏุนุงุก ุงูููุชุฑ ุงูุฎููู ุงูุฌุฏูุฏ)
        const securityResult = await checkTokenSecurity(tokenAddress);
        if (!securityResult.is_safe) {
            return { passed: false, reason: securityResult.reason };
        }
        
        // (ูุญุชูุธ ุจูุญุงูุงุฉ ุงูุจูุนุ ููู ุฃูู ูุญุต Honeypot)
        await routerContract.getAmountsOut.staticCall(ethers.parseUnits("1", 0), [tokenAddress, config.WBNB_ADDRESS]);
        logger.info(`[ูุญุต] โ ูุฌุญุช ูุญุงูุงุฉ ุงูุจูุน. ุงูุนููุฉ ูุงุจูุฉ ููุจูุน.`);
        return { passed: true, reason: "ุงุฌุชุงุฒ ูู ุงููุญูุตุงุช" };
    } catch (error) {
        logger.error(`[ูุญุต] ๐จ ูุดูุช ูุญุงูุงุฉ ุงูุจูุน! ${error.reason || error.message}`);
        return { passed: false, reason: `ูุฎ ุนุณู (Honeypot) - ${error.reason || 'ูุดู ุงุณุชุฏุนุงุก ุงูุนูุฏ'}` };
    }
}

// =================================================================
// 2. ุงูููุงุต (Sniper) - (ูุง ุชุบููุฑ ุนู v2.8)
// =================================================================
async function snipeToken(pairAddress, tokenAddress) {
    try {
        logger.info(`๐๐๐ ุจุฏุก ุนูููุฉ ููุต ูุดุฑุงุก ุงูุนููุฉ: ${tokenAddress} ๐๐๐`);
        const bnbAmountWei = ethers.parseEther(config.BUY_AMOUNT_BNB.toString());
        const path = [config.WBNB_ADDRESS, tokenAddress];
        const amountsOut = await routerContract.getAmountsOut.staticCall(bnbAmountWei, path);
        const minTokens = amountsOut[1] * BigInt(100 - config.SLIPPAGE_LIMIT) / BigInt(100);
        
        const feeData = await provider.getFeeData();
        const txOptions = {
            value: bnbAmountWei,
            gasLimit: config.GAS_LIMIT,
        };

        // (ุงุณุชุฑุงุชูุฌูุฉ ุงูุบุงุฒ ุงูุฏููุงูููู ุถุฑูุฑูุฉ ููููุงุต ุงูุฎุงุทู)
        if (feeData.maxFeePerGas && feeData.maxPriorityFeePerGas) {
            const dynamicPriorityFee = feeData.maxPriorityFeePerGas * BigInt(config.GAS_PRIORITY_MULTIPLIER);
            txOptions.maxFeePerGas = feeData.maxFeePerGas + (dynamicPriorityFee - feeData.maxPriorityFeePerGas); 
            txOptions.maxPriorityFeePerGas = dynamicPriorityFee;
            logger.info(`[ุบุงุฒ] ุฏููุงูููู: ุงูุฃููููุฉ ${ethers.formatUnits(dynamicPriorityFee, 'gwei')} Gwei (ุงูููุชุฑุญ ${ethers.formatUnits(feeData.maxPriorityFeePerGas, 'gwei')} Gwei)`);
        } else {
            txOptions.gasPrice = feeData.gasPrice * BigInt(config.GAS_PRIORITY_MULTIPLIER);
             logger.info(`[ุบุงุฒ] ูุฏูู: ุงูุณุนุฑ ${ethers.formatUnits(txOptions.gasPrice, 'gwei')} Gwei`);
        }
        
        const tx = await routerContract.swapExactETHForTokens(
            minTokens,
            path,
            config.WALLET_ADDRESS,
            Math.floor(Date.now() / 1000) + 120,
            txOptions
        );
        logger.info(`[ุดุฑุงุก] ุชู ุฅุฑุณุงู ุงููุนุงููุฉ ุงููุญููุฉ. ุงููุงุด: ${tx.hash}`);
        const receipt = await tx.wait();
        if (receipt.status === 1) {
            logger.info(`๐ฐ ูุฌุญุช ุนูููุฉ ุงูุดุฑุงุก! ุชู ููุต ${tokenAddress}.`);
            const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, wallet);
            const decimals = await tokenContract.decimals();
            const buyPrice = config.BUY_AMOUNT_BNB / parseFloat(ethers.formatUnits(amountsOut[1], decimals));
            const msg = `๐ฐ <b>ูุฌุญุช ุนูููุฉ ุงูุดุฑุงุก!</b> ๐ฐ\n\n<b>ุงูุนููุฉ:</b> <code>${tokenAddress}</code>\n<b>ุฑุงุจุท ุงููุนุงููุฉ:</b> <a href='https://bscscan.com/tx/${tx.hash}'>BscScan</a>\n<b>๐ ุฑุงุจุท ุงูุดุงุฑุช:</b> <a href='https://dexscreener.com/bsc/${pairAddress}'>DexScreener</a>`;
            telegram.sendMessage(config.TELEGRAM_ADMIN_CHAT_ID, msg, { parse_mode: 'HTML' });
            
            // (ูุง ุฒููุง ุจุญุงุฌุฉ ูู partialTpTaken)
            activeTrades.push({ 
                tokenAddress, 
                pairAddress, 
                buyPrice, 
                initialAmountWei: amountsOut[1], 
                remainingAmountWei: amountsOut[1], 
                decimals, 
                currentProfit: 0, 
                highestProfit: 0,
                partialTpTaken: false 
            });

            saveTradesToFile(); 
            approveMax(tokenAddress);
        } else {
            logger.error(`๐จ ูุดูุช ูุนุงููุฉ ุงูุดุฑุงุก (ุงูุญุงูุฉ 0).`);
        }
    } catch (error) {
        logger.error(`โ ุฎุทุฃ ูุงุฏุญ ูู ุชูููุฐ ุงูุดุฑุงุก: ${error.reason || error}`);
    }
}

async function approveMax(tokenAddress) {
    try {
        logger.info(`[ููุงููุฉ] ุฌุงุฑู ุนูู Approve ูู ${tokenAddress}...`);
        const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, wallet);
        const feeData = await provider.getFeeData();
        const txOptions = {};
        if (feeData.maxFeePerGas && feeData.maxPriorityFeePerGas) {
             txOptions.maxFeePerGas = feeData.maxFeePerGas;
             txOptions.maxPriorityFeePerGas = feeData.maxPriorityFeePerGas; 
        } else {
            txOptions.gasPrice = feeData.gasPrice;
        }
        const tx = await tokenContract.approve(config.ROUTER_ADDRESS, ethers.MaxUint256, txOptions);
        await tx.wait();
        logger.info(`[ููุงููุฉ] โ ุชูุช ุงูููุงููุฉ ุจูุฌุงุญ ูู ${tokenAddress}`);
    } catch (error) {
        logger.error(`โ ูุดูุช ุนูููุฉ ุงูููุงููุฉ: ${error}`);
    }
}

// =================================================================
// 3. ุงูุญุงุฑุณ (Guardian) - (ูุง ุชุบููุฑ ุนู v2.8)
// =================================================================
async function monitorTrades() {
    if (activeTrades.length === 0) return;

    // (ูุธุงู ุงููุฑุงูุจุฉ ุงููุชูุงุฒูุฉ v2.7 ูุง ุฒุงู ูู ุงูุฃูุถู)
    const priceChecks = activeTrades.map(trade => {
        const path = [trade.tokenAddress, config.WBNB_ADDRESS];
        const oneToken = ethers.parseUnits("1", trade.decimals);
        return routerContract.getAmountsOut.staticCall(oneToken, path);
    });

    const results = await Promise.allSettled(priceChecks);

    for (let i = 0; i < activeTrades.length; i++) {
        const trade = activeTrades[i];
        const result = results[i];

        if (result.status === 'fulfilled') {
            try {
                const amountsOut = result.value;
                const currentPrice = parseFloat(ethers.formatUnits(amountsOut[1], 18)); 
                const profit = trade.buyPrice > 0 ? ((currentPrice - trade.buyPrice) / trade.buyPrice) * 100 : 0;
                trade.currentProfit = profit;
                trade.highestProfit = Math.max(trade.highestProfit, profit);

                logger.info(`[ูุฑุงูุจุฉ] ${trade.tokenAddress.slice(0, 10)}... | ุงูุฑุจุญ: ${profit.toFixed(2)}% | ุงูุฃุนูู: ${trade.highestProfit.toFixed(2)}%`);

                // (ููุทู ุฌูู ุงูุฃุฑุจุงุญ ุงูุฌุฒุฆู v2.8 ุถุฑูุฑู ููุฎุงุทู)
                if (config.PARTIAL_TP_PERCENT > 0 && 
                    profit >= config.PARTIAL_TP_PERCENT && 
                    !trade.partialTpTaken) 
                {
                    if (sellingLocks.has(trade.tokenAddress)) {
                        logger.info(`[ุฌูู ุฑุจุญ] TP ูู ${trade.tokenAddress} ูุคุฌู (ุนูููุฉ ุจูุน ุฌุงุฑูุฉ).`);
                        continue; 
                    }
                    
                    logger.info(`๐ฏ [ุฌูู ุฑุจุญ] ุชูุนูู ุฌูู ุงูุฃุฑุจุงุญ ุงูุฌุฒุฆู ูู ${trade.tokenAddress} ุนูุฏ ุฑุจุญ ${profit.toFixed(2)}%`);
                    
                    sellingLocks.add(trade.tokenAddress);
                    trade.partialTpTaken = true; 
                    
                    const amountToSell = (trade.remainingAmountWei * BigInt(config.PARTIAL_TP_SELL_PERCENT)) / 100n;
                    
                    executeSell(trade, amountToSell, `ุฌูู ุฑุจุญ ุฌุฒุฆู ${config.PARTIAL_TP_SELL_PERCENT}%`)
                        .then(success => {
                            if (success) {
                                trade.remainingAmountWei = trade.remainingAmountWei - amountToSell;
                                saveTradesToFile(); 
                            } else {
                                trade.partialTpTaken = false; 
                            }
                        })
                        .finally(() => {
                            sellingLocks.delete(trade.tokenAddress);
                        });
                        
                    continue; 
                }

                // (ููุทู ููู ุงูุฎุณุงุฑุฉ ุงููุชุญุฑู v2.8 ุถุฑูุฑู ููุฎุงุทู)
                if (trade.highestProfit > 0 && profit < trade.highestProfit - config.TRAILING_STOP_LOSS_PERCENT) {
                    
                    if (sellingLocks.has(trade.tokenAddress)) {
                        logger.info(`[ุงูุญุงุฑุณ] TSL ูู ${trade.tokenAddress} ูุคุฌู (ุนูููุฉ ุจูุน ุฌุงุฑูุฉ).`);
                        continue;
                    }
                    
                    logger.info(`๐ฏ [ุงูุญุงุฑุณ] ุชูุนูู ููู ุงูุฎุณุงุฑุฉ ุงููุชุญุฑู ูู ${trade.tokenAddress} ุนูุฏ ุฑุจุญ ${profit.toFixed(2)}%`);
                    
                    sellingLocks.add(trade.tokenAddress);

                    executeSell(trade, trade.remainingAmountWei, `ููู ุฎุณุงุฑุฉ ูุชุญุฑู`)
                        .then(success => {
                            if (success) {
                                removeTrade(trade); 
                            }
                        })
                        .finally(() => {
                            sellingLocks.delete(trade.tokenAddress);
                        });
                }
            } catch (processingError) {
                 logger.error(`[ูุฑุงูุจุฉ] ุฎุทุฃ ูู ูุนุงูุฌุฉ ุณุนุฑ ${trade.tokenAddress}: ${processingError.message}`);
            }
        } else {
            if (result.reason.code === 'CALL_EXCEPTION') {
                 logger.warn(`[ูุฑุงูุจุฉ] ูุฏ ุชููู ุงูุตููุฉ ${trade.tokenAddress} ูุบููุฉ. ุฎุทุฃ: ${result.reason.reason}`);
            } else {
                 logger.error(`[ูุฑุงูุจุฉ] ุฎุทุฃ ูู ุฌูุจ ุณุนุฑ ${trade.tokenAddress}: ${result.reason.message || result.reason}`);
            }
        }
    }
}

async function executeSell(trade, amountToSellWei, reason = "ูุฏูู") {
    if (amountToSellWei <= 0n) { 
         logger.warn(`[ุจูุน] ูุญุงููุฉ ุจูุน ูููุฉ ุตูุฑ ุฃู ุณุงูุจุฉ ูู ${trade.tokenAddress}`);
         return false; 
    }
    try {
        logger.info(`๐ธ [ุจูุน] ุจุฏุก ุนูููุฉ ุจูุน ${reason} ูู ${trade.tokenAddress}... ุงููููุฉ: ${ethers.formatUnits(amountToSellWei, trade.decimals)}`);
        const path = [trade.tokenAddress, config.WBNB_ADDRESS];
        const feeData = await provider.getFeeData();
        const txOptions = { gasLimit: config.GAS_LIMIT };
        // (ุงูุจูุน ุงูุณุฑูุน ุถุฑูุฑู ููุฎุงุทู)
        if (feeData.maxFeePerGas && feeData.maxPriorityFeePerGas) {
             txOptions.maxFeePerGas = feeData.maxFeePerGas;
             txOptions.maxPriorityFeePerGas = feeData.maxPriorityFeePerGas * 2n; 
        } else {
            txOptions.gasPrice = feeData.gasPrice * 2n;
        }
        const tx = await routerContract.swapExactTokensForETHSupportingFeeOnTransferTokens(
            amountToSellWei, 0, path, config.WALLET_ADDRESS, Math.floor(Date.now() / 1000) + 300,
            txOptions
        );
        logger.info(`[ุจูุน] ุชู ุฅุฑุณุงู ูุนุงููุฉ ุงูุจูุน (${reason}). ุงููุงุด: ${tx.hash}`);
        const receipt = await tx.wait();
        if (receipt.status === 1) {
            const msg = `๐ธ <b>ูุฌุญุช ุนูููุฉ ุงูุจูุน (${reason})!</b> ๐ธ\n\n<b>ุงูุนููุฉ:</b> <code>${trade.tokenAddress}</code>\n<b>ุฑุงุจุท ุงููุนุงููุฉ:</b> <a href='https://bscscan.com/tx/${tx.hash}'>BscScan</a>`;
            telegram.sendMessage(config.TELEGRAM_ADMIN_CHAT_ID, msg, { parse_mode: 'HTML' });
            logger.info(`๐ฐ๐ฐ๐ฐ ูุฌุญุช ุนูููุฉ ุงูุจูุน ูู ${trade.tokenAddress}!`);
            return true;
        } else {
             logger.error(`๐จ ูุดูุช ูุนุงููุฉ ุงูุจูุน ${trade.tokenAddress} (ุงูุญุงูุฉ 0).`);
        }
    } catch (error) {
        logger.error(`โ ุฎุทุฃ ูุงุฏุญ ูู ุนูููุฉ ุงูุจูุน ูู ${trade.tokenAddress}: ${error.reason || error}`);
    }
    return false;
}

// =================================================================
// 5. ุชุฎุฒูู ุงูุตููุงุช ุงููุดุทุฉ (Persistence) - (ูุง ุชุบููุฑ ุนู v2.8)
// =================================================================
function replacer(key, value) {
  if (typeof value === 'bigint') { return value.toString(); }
  return value;
}
function reviver(key, value) {
  if (key && key.endsWith('Wei') && typeof value === 'string') { try { return BigInt(value); } catch(e) {} }
  return value;
}
function saveTradesToFile() {
    try {
        const dataToSave = JSON.stringify(activeTrades, replacer, 2);
        fs.writeFileSync(TRADES_FILE, dataToSave, 'utf8');
        logger.info(`๐พ ุชู ุญูุธ ${activeTrades.length} ุตููุฉ ูุดุทุฉ ูู ุงูููู.`);
    } catch (error) {
        logger.error(`๐พ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูุตููุงุช: ${error.message}`);
    }
}
function loadTradesFromFile() {
    try {
        if (fs.existsSync(TRADES_FILE)) {
            const data = fs.readFileSync(TRADES_FILE, 'utf8');
            const loadedTrades = JSON.parse(data, reviver);
            if (Array.isArray(loadedTrades)) {
                 const validTrades = loadedTrades
                    .filter(t => t.tokenAddress && t.remainingAmountWei)
                    .map(t => ({
                        ...t,
                        partialTpTaken: t.partialTpTaken || false 
                    }));
                 activeTrades.push(...validTrades);
            }
        } else {
             logger.info("๐พ ููู ุงูุตููุงุช ุงููุดุทุฉ ุบูุฑ ููุฌูุฏุ ุงูุจุฏุก ุจูุงุฆูุฉ ูุงุฑุบุฉ.");
        }
    } catch (error) {
        logger.error(`๐พ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุตููุงุช: ${error.message}`);
        activeTrades.length = 0;
    }
}
function removeTrade(tradeToRemove) {
    const index = activeTrades.findIndex(t => t.tokenAddress === tradeToRemove.tokenAddress);
    if (index > -1) {
        activeTrades.splice(index, 1);
        logger.info(`๐๏ธ ุชูุช ุฅุฒุงูุฉ ${tradeToRemove.tokenAddress} ูู ูุงุฆูุฉ ุงููุฑุงูุจุฉ.`);
        saveTradesToFile(); 
    }
}

// =================================================================
// 6. ุงูุฑุงุตุฏ ูููุทุฉ ุงูุงูุทูุงู (Watcher & Main) - [ุชุทููุฑ v3.0]
// =================================================================
async function connectAndWatch() {
    let reconnectDelay = 5000;
    const maxDelay = 300000;
    while (true) {
        let heartbeatInterval;
        try {
            logger.info("๐ [ุงูุฑุงุตุฏ] ูุญุงููุฉ ุงูุงุชุตุงู ุจู WebSocket...");
            wssProvider = new ethers.WebSocketProvider(config.NODE_URL);
            await Promise.race([
                wssProvider.ready,
                sleep(30000).then(() => Promise.reject(new Error("WebSocket connection timeout")))
            ]);
            logger.info("โ [ุงูุฑุงุตุฏ] ุชู ุงูุงุชุตุงู ุจู WebSocket ุจูุฌุงุญ!");
            reconnectDelay = 5000;
            factoryContract = new ethers.Contract(config.FACTORY_ADDRESS, FACTORY_ABI, wssProvider);
            logger.info("๐ง [ุงูุฑุงุตุฏ] ุจุฏุก ุงูุงุณุชูุงุน ูุญุฏุซ PairCreated...");
            factoryContract.removeAllListeners('PairCreated');
            factoryContract.on('PairCreated', handlePairCreated);
            heartbeatInterval = setInterval(async () => {
                try { await wssProvider.getBlockNumber(); } catch (heartbeatError) {
                    logger.error("๐ [ุงูุฑุงุตุฏ] ูุดู ูุจุถุฉ WebSocket! ุจุฏุก ุฅุนุงุฏุฉ ุงูุงุชุตุงู...", heartbeatError);
                    clearInterval(heartbeatInterval);
                    wssProvider.websocket.close();
                }
            }, 60000);
            await new Promise((resolve) => {
                wssProvider.websocket.onclose = () => { logger.warn("๐ [ุงูุฑุงุตุฏ] ุงููุทุน ุงุชุตุงู WebSocket!"); clearInterval(heartbeatInterval); resolve(); };
                wssProvider.websocket.onerror = (err) => { logger.error("๐ [ุงูุฑุงุตุฏ] ุฎุทุฃ ูู WebSocket!", err); clearInterval(heartbeatInterval); };
            });
        } catch (error) {
            logger.error(`๐ [ุงูุฑุงุตุฏ] ูุดู ุงูุงุชุตุงู ุฃู ุฎุทุฃ ูุงุฏุญ: ${error.message}. ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ุจุนุฏ ${reconnectDelay / 1000} ุซุงููุฉ...`);
            if (wssProvider && wssProvider.websocket) { wssProvider.websocket.terminate(); }
            if (heartbeatInterval) clearInterval(heartbeatInterval); 
        }
        await sleep(reconnectDelay);
        reconnectDelay = Math.min(reconnectDelay * 2, maxDelay);
    }
}

async function handlePairCreated(token0, token1, pairAddress) {
     if (config.IS_PAUSED) return;
     logger.info(`\n๐ [ุงูุฑุงุตุฏ] ุชู ุฑุตุฏ ูุฌูุน ุฌุฏูุฏ: ${pairAddress}`);
     const targetToken = token0.toLowerCase() === config.WBNB_ADDRESS.toLowerCase() ? token1 : token0;
     if (targetToken.toLowerCase() === config.WBNB_ADDRESS.toLowerCase()) return;
     
     // (ุงุณุชุฏุนุงุก ุฏุงูุฉ ุงููุญุต ุงูุฌุฏูุฏุฉ)
     const checkResult = await fullCheck(pairAddress, targetToken);
     
     if (checkResult.passed) {
         await telegram.sendMessage(config.TELEGRAM_ADMIN_CHAT_ID, `โ <b>ุนููุฉ ุงุฌุชุงุฒุช ุงูููุชุฑ ุงูุฎููู!</b>\n\n<code>${targetToken}</code>\n\n๐ ุฌุงุฑู ูุญุงููุฉ ุงูููุต...`, { parse_mode: 'HTML' });
         snipeToken(pairAddress, targetToken);
     } else {
         logger.warn(`๐ป [ูููุฉ ููุชููุฉ] ุชู ุชุฌุงูู ${targetToken} (ุงูุณุจุจ: ${checkResult.reason}).`);
         if (config.DEBUG_MODE) {
             await telegram.sendMessage(config.TELEGRAM_ADMIN_CHAT_ID, `โช๏ธ <b>ุชู ุชุฌุงูู ุนููุฉ</b>\n\n<code>${targetToken}</code>\n\n<b>ุงูุณุจุจ:</b> ${checkResult.reason}`, { parse_mode: 'HTML' });
         }
     }
}

async function main() {
    logger.info(`--- ุจุฏุก ุชุดุบูู ุจูุช ุตูุงุฏ ุงูุฏุฑุฑ (v3.0 JS) ---`); // [ุชุทููุฑ v3.0]
    try {
        provider = new ethers.JsonRpcProvider(config.PROTECTED_RPC_URL);
        wallet = new ethers.Wallet(config.PRIVATE_KEY, provider);
        routerContract = new ethers.Contract(config.ROUTER_ADDRESS, ROUTER_ABI, wallet);
        loadTradesFromFile();
        logger.info(`๐พ ุชู ุชุญููู ${activeTrades.length} ุตููุฉ ูุดุทุฉ ูู ุงูููู.`);
        const network = await provider.getNetwork();
        logger.info(`โ ุชู ุงูุงุชุตุงู ุจุงูุดุจูุฉ (RPC) ุจูุฌุงุญ! (${network.name}, ChainID: ${network.chainId})`);
        const welcomeMsg = `โ <b>ุชู ุชุดุบูู ุจูุช ุตูุงุฏ ุงูุฏุฑุฑ (v3.0 JS) ุจูุฌุงุญ!</b>`; // [ุชุทููุฑ v3.0]
        telegram.sendMessage(config.TELEGRAM_ADMIN_CHAT_ID, welcomeMsg, { parse_mode: 'HTML', reply_markup: getMainMenuKeyboard() });

        telegram.on('message', (msg) => {
            const chatId = msg.chat.id;
            if (chatId.toString() !== config.TELEGRAM_ADMIN_CHAT_ID) return;
            if (userState[chatId] && userState[chatId].awaiting) {
                const settingKey = userState[chatId].awaiting;
                const newValueStr = msg.text;
                try {
                    let newValue;
                    if (['BUY_AMOUNT_BNB', 'MINIMUM_LIQUIDITY_BNB'].includes(settingKey)) { 
                        newValue = parseFloat(newValueStr); 
                    }
                    else if (settingKey === 'GAS_PRIORITY_MULTIPLIER') { 
                        newValue = parseInt(newValueStr, 10); 
                    }
                    else { 
                        newValue = parseInt(newValueStr, 10); 
                    }
                    if (isNaN(newValue) || newValue < 0) throw new Error("ูููุฉ ุบูุฑ ุตุงูุญุฉ");
                    
                    config[settingKey] = newValue;
                    logger.info(`โ๏ธ ุชู ุชุบููุฑ ${settingKey} ุฏููุงููููุงู ุฅูู ${newValue}.`);
                    telegram.sendMessage(chatId, `โ ุชู ุชุญุฏูุซ <b>${settingKey}</b> ุฅูู: <code>${newValue.toString()}</code>`, { parse_mode: 'HTML', reply_markup: getMainMenuKeyboard() });
                } catch (error) {
                    telegram.sendMessage(chatId, "โ ูููุฉ ุบูุฑ ุตุงูุญุฉ. ูุฑุฌู ุฅุฏุฎุงู ุฑูู ููุฌุจ ุตุญูุญ.", { reply_markup: getMainMenuKeyboard() });
                } finally {
                    delete userState[chatId];
                }
                return;
            }
            switch (msg.text) {
                case 'โธ๏ธ ุฅููุงู ุงูููุต': case 'โถ๏ธ ุงุณุชุฆูุงู ุงูููุต':
                    config.IS_PAUSED = !config.IS_PAUSED;
                    telegram.sendMessage(chatId, `โน๏ธ ุญุงูุฉ ุงูููุต ุงูุขู: <b>${config.IS_PAUSED ? "ููููู โธ๏ธ" : "ูุดุท โถ๏ธ"}</b>`, { parse_mode: 'HTML', reply_markup: getMainMenuKeyboard() });
                    break;
                case '๐ข ุชูุนูู ุงูุชุตุญูุญ': case 'โช๏ธ ุฅููุงู ุงูุชุตุญูุญ':
                    config.DEBUG_MODE = !config.DEBUG_MODE;
                    telegram.sendMessage(chatId, `โน๏ธ ูุถุน ุงูุชุตุญูุญ ุงูุขู: <b>${config.DEBUG_MODE ? "ูุนูุงู ๐ข" : "ุบูุฑ ูุนูุงู โช๏ธ"}</b>`, { parse_mode: 'HTML', reply_markup: getMainMenuKeyboard() });
                    break;
                case '๐ ุงูุญุงูุฉ': showStatus(chatId); break;
                case '๐ฌ ุงูุชุดุฎูุต': showDiagnostics(chatId); break;
                case 'โ๏ธ ุงูุฅุนุฏุงุฏุงุช': showSettingsMenu(chatId); break;
                case '๐ฐ ุจูุน ูุฏูู': showManualSellMenu(chatId); break;
            }
        });

        telegram.on('callback_query', (query) => {
            const chatId = query.message.chat.id;
            const data = query.data;
            if (data.startsWith('change_')) {
                const settingKey = data.replace('change_', '');
                if (SETTING_PROMPTS[settingKey]) {
                     userState[chatId] = { awaiting: settingKey };
                     telegram.editMessageText(SETTING_PROMPTS[settingKey], { chat_id: chatId, message_id: query.message.message_id });
                } else {
                     telegram.answerCallbackQuery(query.id, { text: "ุฅุนุฏุงุฏ ุบูุฑ ูุนุฑูู!" });
                }
            } else if (data.startsWith('manual_sell_')) {
                const tokenAddress = data.replace('manual_sell_', '');
                showSellPercentageMenu(chatId, query.message.message_id, tokenAddress);
            } else if (data.startsWith('partial_sell_')) {
                const [_, percentage, tokenAddress] = data.split('_');
                
                if (sellingLocks.has(tokenAddress)) {
                    telegram.answerCallbackQuery(query.id, { text: "โณ ุฌุงุฑู ุชูููุฐ ุนูููุฉ ุจูุน ุณุงุจูุฉ!" });
                    return; 
                }
                
                const trade = activeTrades.find(t => t.tokenAddress === tokenAddress);
                if (trade) {
                    
                    sellingLocks.add(tokenAddress); 
                    
                    const amount = (trade.remainingAmountWei * BigInt(percentage)) / 100n; 
                    telegram.editMessageText(`โณ ุฌุงุฑู ุจูุน ${percentage}% ูู ${tokenAddress.slice(0,10)}...`, { chat_id: chatId, message_id: query.message.message_id });
                    
                    executeSell(trade, amount, `ุจูุน ูุฏูู ${percentage}%`).then(success => {
                        if (success) {
                            trade.remainingAmountWei = trade.remainingAmountWei - amount;
                            saveTradesToFile(); 

                            if (percentage === '100' || trade.remainingAmountWei <= 0n) {
                                removeTrade(trade); 
                            }
                        } else {
                             telegram.sendMessage(chatId, `โ ูุดูุช ูุญุงููุฉ ุจูุน ${percentage}% ูู ${tokenAddress.slice(0,10)}.`);
                        }
                    }).finally(() => {
                        sellingLocks.delete(tokenAddress);
                    });
                } else {
                     telegram.answerCallbackQuery(query.id, { text: "ุงูุตููุฉ ูู ุชุนุฏ ููุฌูุฏุฉ!" });
                }
            }
        });
        
        connectAndWatch();

        // <<< [ุชุทููุฑ v3.0] ุฒูุงุฏุฉ ุณุฑุนุฉ ุงูุญุงุฑุณ ูุชุชูุงุณุจ ูุน ุงุณุชุฑุงุชูุฌูุฉ "ุงูุฎุงุทู"
        setInterval(monitorTrades, 2000); // Check every 2 seconds

    } catch (error) {
        logger.error(`โ ูุดู ูุงุฏุญ ูู ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ: ${error}`);
        process.exit(1);
    }
}

// --- ุฏูุงู ูุงุฌูุฉ ุงูุชููุฌุฑุงู ุงููุงููุฉ ---
// (ูุง ุชุบููุฑ ุนู v2.8ุ ูุง ุฒุงูุช ุชุนูู ุจุดูู ููุชุงุฒ)

function getMainMenuKeyboard() {
    const pauseButtonText = config.IS_PAUSED ? "โถ๏ธ ุงุณุชุฆูุงู ุงูููุต" : "โธ๏ธ ุฅููุงู ุงูููุต";
    const debugButtonText = config.DEBUG_MODE ? "โช๏ธ ุฅููุงู ุงูุชุตุญูุญ" : "๐ข ุชูุนูู ุงูุชุตุญูุญ";
    return {
        keyboard: [
            [{ text: "๐ ุงูุญุงูุฉ" }, { text: pauseButtonText }],
            [{ text: "๐ฐ ุจูุน ูุฏูู" }, { text: "๐ฌ ุงูุชุดุฎูุต" }],
            [{ text: "โ๏ธ ุงูุฅุนุฏุงุฏุงุช" }, { text: debugButtonText }]
        ],
        resize_keyboard: true
    };
}

function showStatus(chatId) {
    let statusText = "<b>๐ ุงูุญุงูุฉ ุงูุญุงููุฉ ููุจูุช:</b>\n\n";
    statusText += `<b>ุงูุญุงูุฉ:</b> ${config.IS_PAUSED ? 'ููููู ูุคูุชุงู โธ๏ธ' : 'ูุดุท โถ๏ธ'}\n`;
    statusText += `<b>ูุถุน ุงูุชุตุญูุญ:</b> ${config.DEBUG_MODE ? 'ูุนูุงู ๐ข' : 'ุบูุฑ ูุนูุงู โช๏ธ'}\n`;
    statusText += "-----------------------------------\n";
    if (activeTrades.length === 0) {
        statusText += "โน๏ธ ูุง ุชูุฌุฏ ุตููุงุช ูุดุทุฉ ุญุงููุงู.\n";
    } else {
        statusText += "<b>๐ ุงูุตููุงุช ุงููุดุทุฉ:</b>\n";
        activeTrades.forEach(trade => {
            statusText += `<b>- <code>${trade.tokenAddress.slice(0, 10)}...</code>:</b> ${trade.currentProfit.toFixed(2)}%`;
            if (trade.partialTpTaken) {
                statusText += " (ุชู ุฌูู ุงูุฑุจุญ ุงูุฌุฒุฆู โ)";
            }
            statusText += "\n";
        });
    }
    statusText += "-----------------------------------\n";
    statusText += "<b>โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุชุฏุงูู (v3.0 - ุฎุงุทู):</b>\n";
    statusText += `- ูุจูุบ ุงูุดุฑุงุก: ${config.BUY_AMOUNT_BNB} BNB\n`;
    statusText += `- ูุถุงุนู ุงูุบุงุฒ: ${config.GAS_PRIORITY_MULTIPLIER}x\n`;
    statusText += `- ุงูุงูุฒูุงู ุงูุณุนุฑู: ${config.SLIPPAGE_LIMIT}%\n`;
    statusText += `- ุญุฏ ุงูุณูููุฉ: ${config.MINIMUM_LIQUIDITY_BNB} BNB\n`;
    statusText += `- ููู ุงูุฎุณุงุฑุฉ ุงููุชุญุฑู: ${config.TRAILING_STOP_LOSS_PERCENT}%\n`;
    statusText += `- ุฌูู ุงูุฑุจุญ ุงูุฌุฒุฆู: ุจูุน ${config.PARTIAL_TP_SELL_PERCENT}% ุนูุฏ ${config.PARTIAL_TP_PERCENT}% ุฑุจุญ\n`;

    telegram.sendMessage(chatId, statusText, { parse_mode: 'HTML', reply_markup: getMainMenuKeyboard() });
}

function showDiagnostics(chatId) {
    fs.readFile('sniper_bot_pro.log', 'utf8', (err, data) => {
        let logData;
        if (err) { logData = "ููู ุงูุณุฌู ูู ูุชู ุฅูุดุงุคู ุจุนุฏ."; }
        else {
            const lines = data.trim().split('\n');
            logData = lines.slice(-20).join('\n');
            if (!logData) logData = "ููู ุงูุณุฌู ูุงุฑุบ.";
        }
        telegram.sendMessage(chatId, `<b>๐ฌ ุขุฎุฑ 20 ุณุทุฑุงู ูู ุณุฌู ุงูุชุดุฎูุต:</b>\n\n<pre>${logData}</pre>`, { parse_mode: 'HTML' });
    });
}

function showSettingsMenu(chatId) {
    const keyboard = [
        [{ text: `๐ต ูุจูุบ ุงูุดุฑุงุก (${config.BUY_AMOUNT_BNB} BNB)`, callback_data: 'change_BUY_AMOUNT_BNB' }],
        [{ text: `๐ ูุถุงุนู ุงูุบุงุฒ (${config.GAS_PRIORITY_MULTIPLIER}x)`, callback_data: 'change_GAS_PRIORITY_MULTIPLIER' }],
        [{ text: `๐ ุงูุงูุฒูุงู (${config.SLIPPAGE_LIMIT}%)`, callback_data: 'change_SLIPPAGE_LIMIT' }],
        [{ text: `๐ง ุญุฏ ุงูุณูููุฉ (${config.MINIMUM_LIQUIDITY_BNB} BNB)`, callback_data: 'change_MINIMUM_LIQUIDITY_BNB' }],
        [{ text: `๐ ููู ุงูุฎุณุงุฑุฉ ุงููุชุญุฑู (${config.TRAILING_STOP_LOSS_PERCENT}%)`, callback_data: 'change_TRAILING_STOP_LOSS_PERCENT' }],
        [{ text: `๐ฏ ุฑุจุญ ุฌุฒุฆู (% ุงููุฏู) (${config.PARTIAL_TP_PERCENT}%)`, callback_data: 'change_PARTIAL_TP_PERCENT' }],
        [{ text: `๐ฐ ุฑุจุญ ุฌุฒุฆู (% ุงูุจูุน) (${config.PARTIAL_TP_SELL_PERCENT}%)`, callback_data: 'change_PARTIAL_TP_SELL_PERCENT' }],
    ];
    telegram.sendMessage(chatId, "<b>โ๏ธ ุงุฎุชุฑ ุงูุฅุนุฏุงุฏ ุงูุฐู ุชุฑูุฏ ุชุบููุฑู:</b>", {
        parse_mode: "HTML",
        reply_markup: { inline_keyboard: keyboard }
    });
}

function showManualSellMenu(chatId) {
    if (activeTrades.length === 0) {
        telegram.sendMessage(chatId, "โน๏ธ ูุง ุชูุฌุฏ ุตููุงุช ูุดุทุฉ ูุจูุนูุง.");
        return;
    }
    const keyboard = activeTrades.map(trade => ([{
        text: `ุจูุน ${trade.tokenAddress.slice(0, 6)}...${trade.tokenAddress.slice(-4)} (${trade.currentProfit.toFixed(2)}%)`,
        callback_data: `manual_sell_${trade.tokenAddress}`
    }]));
    telegram.sendMessage(chatId, "<b>ุงุฎุชุฑ ุงูุตููุฉ ุงูุชู ุชุฑูุฏ ุฅุฏุงุฑุชูุง:</b>", {
        parse_mode: "HTML",
        reply_markup: { inline_keyboard: keyboard }
    });
}

function showSellPercentageMenu(chatId, messageId, tokenAddress) {
    const keyboard = [
        [{ text: "ุจูุน 25%", callback_data: `partial_sell_25_${tokenAddress}` }, { text: "ุจูุน 50%", callback_data: `partial_sell_50_${tokenAddress}` }],
        [{ text: "ุจูุน 100% (ุงููู)", callback_data: `partial_sell_100_${tokenAddress}` }]
    ];
    telegram.editMessageText(`<b>ุงุฎุชุฑ ูุณุจุฉ ุงูุจูุน ููุนููุฉ <code>${tokenAddress.slice(0,10)}...</code>:</b>`, {
        chat_id: chatId, message_id: messageId, parse_mode: "HTML",
        reply_markup: { inline_keyboard: keyboard }
    });
}

telegram.on('polling_error', (error) => {
    logger.error(`[ุฎุทุฃ ุชููุฌุฑุงู] ${error.code}: ${error.message}`);
});

main();
